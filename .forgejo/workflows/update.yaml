name: Check backend code

on:
  push:
    branches: ["main"]

jobs:
  update-hosts:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        host:
          - nixnest.bushbaby-chimera.ts.net

    steps:
      - uses: actions/setup-node@v6
        with:
          node-version: 24
      - name: NodeJS version
        run: node --version
      - name: Tailscale join
        uses: https://github.com/tailscale/github-action@v4
        continue-on-error: true
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:cicd
          version: latest
          use-cache: "false"
          tailscaled-args: --verbose 2 --tun=userspace-networking --socks5-server=localhost:1055 --outbound-http-proxy-listen=localhost:1055
          ping: ${{ matrix.host }}

      # - run: cat ~/tailscaled.log
      - name: Test connectivity
        run: |
          # Test that we can reach the Tailscale network
          tailscale status

          # Show our IP address
          tailscale ip

      - name: Updating host
        run: |
          export http_proxy=http://localhost:1055/
          export ALL_PROXY=socks5://localhost:1055/
          export HTTP_PROXY=http://localhost:1055/

          curl -X POST -sS --no-buffer --connect-timeout 20 http://${{ matrix.host }}:36196/update
